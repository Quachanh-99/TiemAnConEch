<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tiệm Ăn Con Ếch</title>
 <style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f4f7;
  color: #222;
}

header {
  background: #1f7ae0;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h2 {
  margin: 0;
  font-size: 20px;
}

.small { font-size: 13px; opacity: 0.85 }

.container {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  padding: 12px;
}

.panel {
  background: white;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.products { flex: 2 }
.cart { flex: 1; min-width: 280px }

h3 {
  margin-top: 0;
  font-size: 18px;
}

input, select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  width: 100%;
}

button {
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  background: #1f7ae0;
  color: white;
}

button:active {
  transform: scale(0.97);
}

button.secondary {
  background: #aaa;
}

.product {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.product-name {
  font-size: 16px;
  font-weight: 600;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.cart-item button {
  padding: 6px 10px;
  font-size: 14px;
}

.badge {
  background: #ff9800;
  color: white;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 12px;
}

.hidden { display: none }

.top-actions input {
  width: 140px;
}
</style>
  <!-- Firebase CDN (compat mode for simpler single-file example) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <h2>Tiệm Ăn Con Ếch</h2>
      <div class="small">
  Cửa hàng: <span id="storeIdDisplay">demo-store</span> · Cơm & Cháo Ếch Singapore
</div>
    </div>

    <div class="top-actions">
      <div id="authArea" class="loginbox">
        <input id="email" placeholder="Email" />
        <input id="password" placeholder="Mật khẩu" type="password" />
        <button id="btnLogin">Đăng nhập</button>
        <button id="btnSignup">Tạo user</button>
      </div>

      <div id="userArea" class="hidden">
        <span id="userEmail"></span>
        <button id="btnLogout">Đăng xuất</button>
      </div>

      <div id="status" class="small">Status: <span id="netStatus">—</span></div>
    </div>
  </header>

  <div class="container">
    <div class="panel products">
      <h3>Products <span id="prodCount" class="badge">0</span></h3>
      <div id="productsList">
        <!-- products loaded here -->
      </div>
      <hr />
      <div>
        <h4>Quản lý sản phẩm (demo nhanh)</h4>
        <input id="pName" placeholder="Tên sản phẩm" />
        <input id="pPrice" placeholder="Giá (VNĐ)" type="number" />
        <button id="btnAddProduct">Thêm/Update</button>
        <div class="small">* Thêm ở store demo-store. Để xóa/ sửa dùng Firebase Console.</div>
      </div>
    </div>

    <div class="panel cart">
      <h3>Cart / Thanh toán</h3>
      <div id="cartList"></div>
      <div style="margin-top:10px">
        <div class="small">Tổng: <b id="totalAmount">0</b> VNĐ</div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <select id="paymentMethod">
            <option value="cash">Tiền mặt</option>
            <option value="momo">Ví điện tử</option>
            <option value="card">Thẻ</option>
          </select>
          <button id="btnPay">Thanh toán</button>
          <button id="btnClear">Xóa giỏ</button>
        </div>
      </div>

      <hr />
      <h4>Hóa đơn mới nhất</h4>
      <div id="lastOrder"></div>
      <div style="margin-top:8px">
        <button id="btnPrintInvoice" class="hidden">In hóa đơn</button>
      </div>
    </div>
  </div>

  <footer>
    <div>Ghi chú: Đây là demo MVP chạy trên 1 file HTML. Để an toàn, cấu hình Firestore Rules & custom claims khi vào production.</div>
  </footer>

<script>
  // ====== CẬP NHẬT firebaseConfig Ở ĐÂY ======
 // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC-AaAzc1qOsRjs1Pa3IrHKRtT4ID2incI",
  authDomain: "pos-quocanh.firebaseapp.com",
  projectId: "pos-quocanh",
  storageBucket: "pos-quocanh.firebasestorage.app",
  messagingSenderId: "564307196330",
  appId: "1:564307196330:web:ac98a34f838b20300213d3"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
  // =========================================

  // Init Firebase (compat mode)
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const storeId = "demo-store"; // đơn giản: dùng 1 store id cố định
  document.getElementById('storeIdDisplay').textContent = storeId;

  // enable offline persistence (indexedDB)
  db.enablePersistence({ synchronizeTabs: true }).catch(function(err) {
    console.warn("Persistence error:", err && err.code);
  });

  // UI elements
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const authArea = document.getElementById('authArea');
  const userArea = document.getElementById('userArea');
  const userEmail = document.getElementById('userEmail');
  const btnLogout = document.getElementById('btnLogout');
  const netStatus = document.getElementById('netStatus');

  const productsList = document.getElementById('productsList');
  const prodCount = document.getElementById('prodCount');
  const pName = document.getElementById('pName');
  const pPrice = document.getElementById('pPrice');
  const btnAddProduct = document.getElementById('btnAddProduct');

  const cartList = document.getElementById('cartList');
  const totalAmountEl = document.getElementById('totalAmount');
  const btnPay = document.getElementById('btnPay');
  const btnClear = document.getElementById('btnClear');
  const paymentMethod = document.getElementById('paymentMethod');

  const lastOrderEl = document.getElementById('lastOrder');
  const btnPrintInvoice = document.getElementById('btnPrintInvoice');

  // Network status
  function updateOnlineStatus() {
    netStatus.textContent = navigator.onLine ? "online" : "offline";
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  // Authentication
  btnSignup.onclick = async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass) return alert('Nhập email và mật khẩu');
    try {
      await auth.createUserWithEmailAndPassword(email, pass);
      alert('Tạo user thành công. Đăng nhập ngay.');
    } catch(e) { alert('Signup error: ' + e.message) }
  };

  btnLogin.onclick = async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass) return alert('Nhập email và mật khẩu');
    try {
      await auth.signInWithEmailAndPassword(email, pass);
    } catch(e){ alert('Login error: '+e.message) }
  };

  btnLogout.onclick = async () => {
    await auth.signOut();
  };

  auth.onAuthStateChanged(user => {
    if(user) {
      authArea.classList.add('hidden');
      userArea.classList.remove('hidden');
      userEmail.textContent = user.email;
    } else {
      authArea.classList.remove('hidden');
      userArea.classList.add('hidden');
      userEmail.textContent = '';
    }
  });

  // ========== PRODUCTS realtime ==========
  let products = []; // local cache
  const productsRef = db.collection('stores').doc(storeId).collection('products');

  productsRef.onSnapshot(snapshot => {
    products = [];
    snapshot.forEach(doc => {
      products.push({ id: doc.id, ...doc.data() });
    });
    renderProducts();
  }, err => {
    console.error('products listener error', err);
  });

  function renderProducts(){
    productsList.innerHTML = '';
    prodCount.textContent = products.length;
    if(products.length === 0) {
      productsList.innerHTML = '<div class="small">Chưa có sản phẩm. Thêm thử bên dưới.</div>';
      return;
    }
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <div>
          <div class="product-name">${escapeHtml(p.name)}</div>
          <div class="small">Giá: ${formatMoney(p.price)} VNĐ</div>
        </div>
        <div>
          <button data-id="${p.id}" class="btnAdd">Thêm</button>
        </div>
      `;
      productsList.appendChild(div);
    });
    // attach handlers
    Array.from(document.getElementsByClassName('btnAdd')).forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute('data-id');
        const prod = products.find(x=>x.id===id);
        if(prod) addToCart(prod);
      };
    });
  }

  // add product (quick demo)
  btnAddProduct.onclick = async () => {
    const name = pName.value.trim();
    const price = parseInt(pPrice.value||0);
    if(!name || !price) return alert('Nhập tên và giá');
    try {
      // create doc id from name slug for demo
      const id = name.toLowerCase().replace(/\s+/g,'-');
      await productsRef.doc(id).set({ name, price });
      pName.value = ''; pPrice.value = '';
      alert('Đã thêm/ cập nhật sản phẩm');
    } catch(e) {
      alert('Error add product: ' + e.message);
    }
  };

  // ========== CART logic ==========
  let cart = [];

  function addToCart(prod) {
    const idx = cart.findIndex(i=>i.id===prod.id);
    if(idx>=0) cart[idx].qty++;
    else cart.push({ id: prod.id, name: prod.name, price: prod.price, qty: 1 });
    renderCart();
  }

  function renderCart() {
    cartList.innerHTML = '';
    if(cart.length===0) cartList.innerHTML = '<div class="small">Giỏ trống</div>';
    cart.forEach(item=>{
      const div = document.createElement('div');
      div.className = 'cart-item';
      div.innerHTML = `
        <div>${escapeHtml(item.name)} x${item.qty}</div>
        <div>
          <button data-id="${item.id}" class="dec">-</button>
          <button data-id="${item.id}" class="inc">+</button>
          <button data-id="${item.id}" class="rem">x</button>
        </div>
      `;
      cartList.appendChild(div);
    });
    Array.from(document.getElementsByClassName('inc')).forEach(b=>{
      b.onclick = ()=> { const id=b.getAttribute('data-id'); changeQty(id,1); };
    });
    Array.from(document.getElementsByClassName('dec')).forEach(b=>{
      b.onclick = ()=> { const id=b.getAttribute('data-id'); changeQty(id,-1); };
    });
    Array.from(document.getElementsByClassName('rem')).forEach(b=>{
      b.onclick = ()=> { const id=b.getAttribute('data-id'); removeItem(id); };
    });

    const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);
    totalAmountEl.textContent = formatMoney(total);
  }

  function changeQty(id, delta) {
    const idx = cart.findIndex(i=>i.id===id);
    if(idx>=0) {
      cart[idx].qty += delta;
      if(cart[idx].qty <= 0) cart.splice(idx,1);
      renderCart();
    }
  }
  function removeItem(id) {
    cart = cart.filter(i => i.id !== id);
    renderCart();
  }
  btnClear.onclick = ()=> { cart = []; renderCart(); };

  // ========== Orders: create + realtime last order ==========
  const ordersRef = db.collection('stores').doc(storeId).collection('orders');

  btnPay.onclick = async () => {
    if(cart.length === 0) return alert('Giỏ rỗng');
    const user = auth.currentUser;
    const order = {
      items: cart.map(i=>({ productId: i.id, name: i.name, qty: i.qty, unitPrice: i.price })),
      subtotal: cart.reduce((s,i)=>s + i.price*i.qty, 0),
      total: cart.reduce((s,i)=>s + i.price*i.qty, 0),
      status: 'paid',
      createdBy: user ? user.uid : 'anonymous',
      createdByEmail: user ? user.email : null,
      paymentMethod: paymentMethod.value,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      const docRef = await ordersRef.add(order);
      cart = []; renderCart();
      alert('Thanh toán thành công. Order id: ' + docRef.id);
      // show last order live via listener below
    } catch(e) {
      alert('Thanh toán lỗi: ' + e.message);
    }
  };

  // listen last order realtime
  ordersRef.orderBy('createdAt','desc').limit(1)
    .onSnapshot(snapshot => {
      if(snapshot.empty) {
        lastOrderEl.innerHTML = '<div class="small">Chưa có hóa đơn</div>';
        btnPrintInvoice.classList.add('hidden');
        return;
      }
      snapshot.forEach(doc=>{
        const data = { id: doc.id, ...doc.data() };
        renderLastOrder(data);
      });
    });

  function renderLastOrder(order){
    const time = order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : '—';
    lastOrderEl.innerHTML = `
      <div><b>ID:</b> ${order.id}</div>
      <div><b>Người làm:</b> ${order.createdByEmail||order.createdBy}</div>
      <div><b>Thời gian:</b> ${escapeHtml(time)}</div>
      <div><b>Tổng:</b> ${formatMoney(order.total)} VNĐ</div>
      <div style="margin-top:8px">
        <b>Items:</b>
        <ul>
          ${order.items.map(i=>`<li>${escapeHtml(i.name)} x${i.qty} — ${formatMoney(i.unitPrice)} each</li>`).join('')}
        </ul>
      </div>
    `;
    btnPrintInvoice.classList.remove('hidden');
    btnPrintInvoice.onclick = ()=> {
      printOrder(order);
    };
  }

  function printOrder(order){
    const html = `
      <html><head><title>Invoice ${order.id}</title>
        <style>body{font-family:Arial;} h3{margin-bottom:0}</style>
      </head><body>
        <h3>Hóa đơn - ${escapeHtml(order.id)}</h3>
        <div>${escapeHtml(order.createdByEmail || order.createdBy)}</div>
        <div>${order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : ''}</div>
        <hr/>
        <ul>
          ${order.items.map(i=>`<li>${escapeHtml(i.name)} x${i.qty} — ${formatMoney(i.unitPrice)} VNĐ</li>`).join('')}
        </ul>
        <hr/>
        <div><b>Tổng: ${formatMoney(order.total)} VNĐ</b></div>
      </body></html>
    `;
    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
    w.print();
  }

  // ======= util =======
  function formatMoney(n){ return new Intl.NumberFormat('en-US').format(n); }
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // initial render
  renderCart();

  // ========== OPTIONAL: Firestore rules suggestion ==========
  // Note: you must set rules in Firebase Console; below is a recommended starting point:
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /stores/{storeId}/{docPath=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
        // For production, restrict writes by role/custom claims
      }
    }
  }
  */

</script>
</body>
</html>
