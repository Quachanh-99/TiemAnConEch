<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Tiệm Ăn Con Ếch</title>

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#f2f4f7;
}
header{
  background:#1f7ae0;
  color:white;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  display:flex;
  gap:12px;
  padding:12px;
  flex-wrap:wrap;
}
.panel{
  background:white;
  padding:12px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.products{flex:2}
.cart{flex:1;min-width:280px}

/* bàn */
.table{
  padding:12px;
  border-radius:10px;
  text-align:center;
  background:#ddd;
  font-weight:600;
  cursor:pointer;
}
.table.active{background:#ffd54f;}
.table.staff{background:#b0b0b0;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <h2>Tiệm Ăn Con Ếch</h2>
  <div>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mật khẩu">
    <button id="btnLogin">Đăng nhập</button>
    <button id="btnSignup">Tạo user</button>
    <button id="btnLogout">Đăng xuất</button>
  </div>
</header>

<div class="container">

  <!-- BÀN -->
  <div class="panel">
    <h3>Bàn</h3>
    <div id="tablesGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
  </div>

  <!-- SẢN PHẨM -->
  <div class="panel products">
    <h3>Sản phẩm</h3>
    <div id="productsList"></div>
    <hr>
    <input id="pName" placeholder="Tên">
    <input id="pPrice" type="number" placeholder="Giá">
    <button id="btnAddProduct">Thêm sản phẩm</button>
  </div>

  <!-- GIỎ -->
  <div class="panel cart">
    <h3>Giỏ hàng</h3>
    <div id="cartList"></div>
    <p>Tổng: <b id="totalAmount">0</b> VNĐ</p>
    <select id="paymentMethod">
      <option value="cash">Tiền mặt</option>
      <option value="bank">Chuyển khoản</option>
    </select>
    <button id="btnPay">Thanh toán</button>
    <button id="btnClear">Xóa giỏ</button>
  </div>

</div>

<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC-AaAzc1qOsRjs1Pa3IrHKRtT4ID2incI",
  authDomain: "pos-quocanh.firebaseapp.com",
  projectId: "pos-quocanh",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== Tables ===== */
const tables = [
  {id:1,name:"Bàn 1",type:"normal"},
  {id:2,name:"Bàn 2",type:"normal"},
  {id:3,name:"Bàn 3",type:"normal"},
  {id:4,name:"Bàn 4",type:"normal"},
  {id:99,name:"Bàn nhân viên",type:"staff"}
];
let currentTable=null;

const tablesGrid=document.getElementById("tablesGrid");

function renderTables(){
  tablesGrid.innerHTML="";
  tables.forEach(t=>{
    const div=document.createElement("div");
    div.className="table";
    if(t.type==="staff") div.classList.add("staff");
    div.textContent=t.name;
    div.onclick=()=>{
      currentTable=t;
      document.querySelectorAll(".table").forEach(x=>x.classList.remove("active"));
      div.classList.add("active");
      alert("Đang chọn: "+t.name);
    };
    tablesGrid.appendChild(div);
  });
}
renderTables();

/* ===== Auth ===== */
btnSignup.onclick=async()=>{
  await auth.createUserWithEmailAndPassword(email.value,password.value);
  alert("Tạo user xong");
};
btnLogin.onclick=async()=>{
  await auth.signInWithEmailAndPassword(email.value,password.value);
};
btnLogout.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(user){
    const ref=db.collection("users").doc(user.uid);
    const snap=await ref.get();
    if(!snap.exists){
      let role="staff";
      if(user.email==="tiemanconech@admin.local") role="owner";
      await ref.set({
        email:user.email,
        role,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    alert("Đăng nhập thành công: "+user.email);
  }
});

/* ===== Products ===== */
const storeId="demo-store";
const productsRef=db.collection("stores").doc(storeId).collection("products");
let products=[];
productsRef.onSnapshot(snap=>{
  products=[];
  snap.forEach(d=>products.push({id:d.id,...d.data()}));
  renderProducts();
});

function renderProducts(){
  productsList.innerHTML="";
  products.forEach(p=>{
    const div=document.createElement("div");
    div.innerHTML=`
      ${p.name} - ${p.price} VNĐ 
      <button onclick="addToCart('${p.id}')">+</button>
    `;
    productsList.appendChild(div);
  });
}

btnAddProduct.onclick=async()=>{
  const name=pName.value;
  const price=parseInt(pPrice.value);
  const id=name.toLowerCase().replace(/\s+/g,"-");
  await productsRef.doc(id).set({name,price});
  alert("Đã thêm sản phẩm");
};

/* ===== Cart ===== */
let cart=[];

function addToCart(id){
  const p=products.find(x=>x.id===id);
  let item=cart.find(x=>x.id===id);
  if(item) item.qty++;
  else cart.push({...p,qty:1});
  renderCart();
}

function renderCart(){
  cartList.innerHTML="";
  let total=0;
  cart.forEach(i=>{
    total+=i.price*i.qty;
    const div=document.createElement("div");
    div.textContent=`${i.name} x${i.qty}`;
    cartList.appendChild(div);
  });
  totalAmount.textContent=total;
}

btnClear.onclick=()=>{
  cart=[];
  renderCart();
};

/* ===== Thanh toán ===== */
const ordersRef=db.collection("stores").doc(storeId).collection("orders");

btnPay.onclick=async()=>{
  if(!currentTable) return alert("Chưa chọn bàn");
  if(cart.length===0) return alert("Giỏ trống");

  // Bàn nhân viên thì không lưu
  if(currentTable.type==="staff"){
    alert("Bàn nhân viên, không ghi doanh thu");
    cart=[];
    renderCart();
    return;
  }

  await ordersRef.add({
    tableId:currentTable.id,
    tableName:currentTable.name,
    items:cart,
    total:cart.reduce((s,i)=>s+i.price*i.qty,0),
    paymentMethod:paymentMethod.value,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("Thanh toán thành công cho "+currentTable.name);
  cart=[];
  renderCart();
};
</script>

</body>
</html>
