<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ti·ªám ƒÇn Con ·∫æch</title>
 <style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f4f7;
  color: #222;
}

header {
  background: #1f7ae0;
  color: white;
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header h2 {
  margin: 0;
  font-size: 20px;
}

.small { font-size: 13px; opacity: 0.85 }

.container {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 10px;
}


.panel {
  background: white;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.products { flex: 2 }
.cart { flex: 1; min-width: 280px }

h3 {
  margin-top: 0;
  font-size: 18px;
}

input, select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  width: 100%;
}

button {
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  background: #1f7ae0;
  color: white;
}

button:active {
  transform: scale(0.97);
}

button.secondary {
  background: #aaa;
}

.product {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
}

.product-name {
  font-size: 16px;
  font-weight: 600;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.cart-item button {
  padding: 6px 10px;
  font-size: 14px;
}

.badge {
  background: #ff9800;
  color: white;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 12px;
}

.hidden { display: none }

.top-actions input {
  width: 140px;
}
.tables {
  position: relative;
  width: 100%;
  min-height: 380px;
  background: #f9fafb;
  border-radius: 12px;
  border: 2px dashed #ddd;
}

.table {
  position: absolute;
  width: 70px;
  height: 50px;
  border: 2px solid #333;
  border-radius: 8px;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: #fff;
}

.table.empty { background: #e5e7eb; }
.table.busy { background: #facc15; }  /* v√†ng */
.table.staff { background: #9ca3af; color: white; }
.table.active { outline: 3px solid #2563eb; }

@media (max-width: 430px){
  header{
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }

  .container{
    padding: 6px;
  }

  .tables{
    height: 460px;
  }

  .table{
    width: 64px;
    height: 46px;
    font-size: 13px;
  }

  button{
    padding: 8px 12px;
    font-size: 14px;
  }

  .product-name{
    font-size: 15px;
  }

  .cart-item button{
    padding: 4px 8px;
    font-size: 13px;
  }
}

.qty-badge{
  font-weight: 900;
  font-size: 16px;
  color: #dc2626;   /* ƒë·ªè ƒë·∫≠m */
}
.cart-total{
  margin-top: 10px;
  font-size: 16px;
}

.cart-total-price{
  font-size: 22px;
  font-weight: 900;
  color: #dc2626;
}

</style>
  <!-- Firebase CDN (compat mode for simpler single-file example) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <h2>Ti·ªám ƒÇn Con ·∫æch</h2>
      <div class="small">
  C·ª≠a h√†ng: <span id="storeIdDisplay">demo-store</span> ¬∑ C∆°m & Ch√°o ·∫æch Singapore
</div>
    </div>

    <div class="top-actions">
      <div id="authArea" class="loginbox">
        <input id="email" placeholder="Email" />
        <input id="password" placeholder="M·∫≠t kh·∫©u" type="password" />
        <button id="btnLogin">ƒêƒÉng nh·∫≠p</button>
        <button id="btnSignup">T·∫°o user</button>
      </div>

     <div id="userArea" class="hidden">
  <span id="userEmail"></span>
  <button id="btnHistory">üìä L·ªãch s·ª≠</button>
  <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
</div>


      <div id="status" class="small">Status: <span id="netStatus">‚Äî</span></div>
    </div>
  </header>

 <div class="container" id="tableScreen">

    <div class="panel">
     <h3>B√†n</h3>
     <div id="tablesGrid" class="tables"></div>
    </div>

   
      <hr />
      <div id="productAdmin">
        <h4>Qu·∫£n l√Ω s·∫£n ph·∫©m</h4>
        <input id="pName" placeholder="T√™n s·∫£n ph·∫©m" />
        <input id="pPrice" placeholder="Gi√° (VNƒê)" type="number" />
        <button id="btnAddProduct">Th√™m/Update</button>
  
      </div>
    </div>
  
    <div class="container hidden" id="historyView">
  <div class="panel">
    <h3>üìä L·ªãch s·ª≠ b√°n h√†ng 7 ng√†y</h3>
    <div id="daysList"></div>
    <hr/>
    <div id="dayDetail"></div>
    <button id="btnBack">‚¨Ö Quay l·∫°i POS</button>
  </div>
</div>
     <div id="orderScreen" class="hidden">
     
    <div class="panel cart">
      <h3>Cart / Thanh to√°n</h3>
      <div id="tableNumberDisplay" style="
          font-weight:bold;
          font-size:18px;
          margin-bottom:6px;
       ">
          B√†n: --
      </div>


      <div id="cartList"></div>
      <div style="margin-top:10px">
        <div class="cart-total">
  	T·ªïng:
  	<span id="totalAmount" class="cart-total-price">0</span> VNƒê
	</div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center">
          <select id="paymentMethod">
            <option value="cash">Ti·ªÅn m·∫∑t</option>
            <option value="momo">Chuy·ªÉn kho·∫£n</option>
          </select>
          <button onclick="changeTable()">ƒê·ªïi b√†n</button>
          <button id="btnPay">Thanh to√°n</button>
          <button id="btnClear">X√≥a bill</button>
        </div>
      </div>
      <div class="panel products">
      <h3>Products <span id="prodCount" class="badge">0</span></h3>
      <div id="productsList">
        <!-- products loaded here -->
      </div>
      </div>
      <hr />
      <h4>H√≥a ƒë∆°n m·ªõi nh·∫•t</h4>
      <div id="lastOrder"></div>
      <div style="margin-top:8px">
        <button id="btnPrintInvoice" class="hidden">In h√≥a ƒë∆°n</button>
      </div>
    </div>
  </div>

  <footer>
    <div>Made by Qu·ªëc Anh ‚ù§Ô∏è</div>
  </footer>

<script>
  // ====== GLOBAL STATE ======
  let currentTable = null;
 
  // ====== C·∫¨P NH·∫¨T firebaseConfig ·ªû ƒê√ÇY ======
 // https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC-AaAzc1qOsRjs1Pa3IrHKRtT4ID2incI",
  authDomain: "pos-quocanh.firebaseapp.com",
  projectId: "pos-quocanh",
  storageBucket: "pos-quocanh.appspot.com",
  messagingSenderId: "564307196330",
  appId: "1:564307196330:web:ac98a34f838b20300213d3"
};

  // =========================================

  // Init Firebase (compat mode)
 firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storeId = "demo-store"; // ƒë∆°n gi·∫£n: d√πng 1 store id c·ªë ƒë·ªãnh
const ordersRef = db.collection('stores').doc(storeId).collection('orders');
const tablesRef = db.collection("stores").doc(storeId).collection("tables");

  document.getElementById('storeIdDisplay').textContent = storeId;

  // enable offline persistence (indexedDB)
  db.enablePersistence({ synchronizeTabs: true }).catch(function(err) {
    console.warn("Persistence error:", err && err.code);
  });

  // UI elements
  const emailEl = document.getElementById('email');
  const passEl = document.getElementById('password');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const authArea = document.getElementById('authArea');
  const userArea = document.getElementById('userArea');
  const userEmail = document.getElementById('userEmail');
  const btnLogout = document.getElementById('btnLogout');
  const netStatus = document.getElementById('netStatus');

  const productsList = document.getElementById('productsList');
  const prodCount = document.getElementById('prodCount');
  const pName = document.getElementById('pName');
  const pPrice = document.getElementById('pPrice');
  const btnAddProduct = document.getElementById('btnAddProduct');

  const cartList = document.getElementById('cartList');
  const totalAmountEl = document.getElementById('totalAmount');
  const btnPay = document.getElementById('btnPay');
  const btnClear = document.getElementById('btnClear');
  
 btnClear.onclick = async () => {
  if(!currentTable) return;

  await tablesRef.doc(String(currentTable.id)).set({
    cart: [],
    status: "empty",
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });

  alert("ƒê√£ x√≥a bill b√†n " + currentTable.name);
};




  const paymentMethod = document.getElementById('paymentMethod');

  const lastOrderEl = document.getElementById('lastOrder');
  const btnPrintInvoice = document.getElementById('btnPrintInvoice');

  // Network status
  function updateOnlineStatus() {
    netStatus.textContent = navigator.onLine ? "online" : "offline";
  }
  window.addEventListener('online', updateOnlineStatus);
  window.addEventListener('offline', updateOnlineStatus);
  updateOnlineStatus();

  // Authentication
  btnSignup.onclick = async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass) return alert('Nh·∫≠p email v√† m·∫≠t kh·∫©u');
    try {
      await auth.createUserWithEmailAndPassword(email, pass);
      alert('T·∫°o user th√†nh c√¥ng. ƒêƒÉng nh·∫≠p ngay.');
    } catch(e) { alert('Signup error: ' + e.message) }
  };

  btnLogin.onclick = async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if(!email || !pass) return alert('Nh·∫≠p email v√† m·∫≠t kh·∫©u');
    try {
      await auth.signInWithEmailAndPassword(email, pass);
    } catch(e){ alert('Login error: '+e.message) }
  };

  btnLogout.onclick = async () => {
    await auth.signOut();
  };

  
auth.onAuthStateChanged(async (user) => {
  if (user) {
    authArea.classList.add('hidden');
    userArea.classList.remove('hidden');
    userEmail.textContent = user.email;

    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();

    if (!snap.exists) {
      let role = "staff";
      if (user.email === "tiemanconech@admin.local") role = "owner";

      await userRef.set({
        email: user.email,
        role: role,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      window.currentUser = { email: user.email, role: role };
    } else {
      window.currentUser = snap.data();
      
    }
	console.log("USER ROLE:", window.currentUser.role);
    applyRoleUI();
	renderProducts();
  } else {
    authArea.classList.remove('hidden');
    userArea.classList.add('hidden');
    userEmail.textContent = '';
    window.currentUser = null;
  }
});


  // ========== PRODUCTS realtime ==========
  let products = []; // local cache
  const productsRef = db.collection('stores').doc(storeId).collection('products');

  productsRef.onSnapshot(snapshot => {
    products = [];
    snapshot.forEach(doc => {
      products.push({ id: doc.id, ...doc.data() });
    });
    renderProducts();
  }, err => {
    console.error('products listener error', err);
  });
  

  function renderProducts(){
    productsList.innerHTML = '';
    prodCount.textContent = products.length;
    if(products.length === 0) {
      productsList.innerHTML = '<div class="small">Ch∆∞a c√≥ s·∫£n ph·∫©m. Th√™m th·ª≠ b√™n d∆∞·ªõi.</div>';
      return;
    }
    products.forEach(p => {
  	const div = document.createElement('div');
  	div.className = 'product';

  	let deleteBtn = "";
  	if (window.currentUser && window.currentUser.role === "owner") {
        deleteBtn = `<button data-id="${p.id}" class="btnDelete" style="background:#ef4444">X√≥a</button>`;
  	}

  	div.innerHTML = `
    	<div>
           <div class="product-name">${escapeHtml(p.name)}</div>
           <div class="small">Gi√°: ${formatMoney(p.price)} VNƒê</div>
        </div>
        <div style="display:flex; gap:6px">
           <button data-id="${p.id}" class="btnAdd">Th√™m</button>
           ${deleteBtn}
        </div>
   `;
  productsList.appendChild(div);
});
    //n√∫t th√™m
    // attach handlers
    Array.from(document.getElementsByClassName('btnAdd')).forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute('data-id');
        const prod = products.find(x=>x.id===id);
        if(prod) addToCart(prod);
      };
    });
    // n√∫t x√≥a
    Array.from(document.getElementsByClassName('btnDelete')).forEach(b=>{
  	b.onclick = async () => {
    	if(!currentUser || currentUser.role !== "owner"){
        return alert("Ch·ªâ ch·ªß qu√°n m·ªõi ƒë∆∞·ª£c x√≥a s·∫£n ph·∫©m");
        }

    	const id = b.getAttribute('data-id');
    	if(!confirm("X√≥a s·∫£n ph·∫©m n√†y lu√¥n nha?")) return;

    	try{
          await productsRef.doc(id).delete();
          alert("ƒê√£ x√≥a s·∫£n ph·∫©m");
    	}catch(e){
          alert("L·ªói khi x√≥a: " + e.message);
        }
  	};
    });
  }

  // add product (quick demo)
  btnAddProduct.onclick = async () => {
    const name = pName.value.trim();
    const price = parseInt(pPrice.value||0);
    if(!currentUser || currentUser.role !== "owner"){
    return alert("Ch·ªâ ch·ªß qu√°n m·ªõi ƒë∆∞·ª£c th√™m s·∫£n ph·∫©m");
    }
    if(!name || !price) return alert('Nh·∫≠p t√™n v√† gi√°');
    try {
      // create doc id from name slug for demo
      const id = name.toLowerCase().replace(/\s+/g,'-');
      await productsRef.doc(id).set({ name, price });
      pName.value = ''; pPrice.value = '';
      alert('ƒê√£ th√™m/ c·∫≠p nh·∫≠t s·∫£n ph·∫©m');
    } catch(e) {
      alert('Error add product: ' + e.message);
    }
  };

  // ========== CART logic ==========
 
  function applyRoleUI(){
  	if(!window.currentUser) return;

  	const isOwner = window.currentUser.role === "owner";

  	// Khu qu·∫£n l√Ω s·∫£n ph·∫©m
  	const productAdmin = document.getElementById("productAdmin");
  	if(productAdmin){
    	productAdmin.style.display = isOwner ? "block" : "none";
  	}

  	// N√∫t l·ªãch s·ª≠
  	const btnHistory = document.getElementById("btnHistory");
  	if(btnHistory){
    	btnHistory.style.display = isOwner ? "inline-block" : "none";
  	}
  }

 
  async function addToCart(prod){
  if(!currentTable) return alert("Ch·ªçn b√†n tr∆∞·ªõc");

  let cart = currentTable.cart || [];
  const idx = cart.findIndex(i=>i.id===prod.id);
  if(idx>=0) cart[idx].qty++;
  else cart.push({ 
	id: prod.id, 
	name: prod.name, 
	price: prod.price, 
	qty: 1,
	note: ""   // ‚Üê note
});
       
  await tablesRef.doc(String(currentTable.id)).set({
    cart: cart,
    status: "busy",
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}



async function changeQty(id, delta){
  if(!currentTable) return;

  let cart = currentTable.cart || [];
  const idx = cart.findIndex(i=>i.id===id);

  if(idx>=0){
    cart[idx].qty += delta;
    if(cart[idx].qty <= 0) cart.splice(idx,1);

    await tablesRef.doc(String(currentTable.id)).update({
  cart: cart,
  status: "busy",
  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });
  }
}






function renderCart(){
  if(!currentTable) return;

  if(!currentTable.cart) currentTable.cart = [];
  document.getElementById("tableNumberDisplay").innerText =
    currentTable ? "B√†n: " + currentTable.name : "Ch∆∞a ch·ªçn b√†n";

  if(!currentTable){
    cartList.innerHTML = '<div class="small">Ch∆∞a ch·ªçn b√†n</div>';
    totalAmountEl.textContent = "0";
    return;
  }

  
  

  const cart = currentTable.cart || [];

  cartList.innerHTML = "";
  let total = 0;

  if(cart.length === 0){
    cartList.innerHTML = '<div class="small">Gi·ªè tr·ªëng</div>';
    totalAmountEl.textContent = "0";
    return;
  }

  cart.forEach(i=>{
  const row = document.createElement("div");
  row.className = "cart-item";

  row.innerHTML = `
  <div style="flex:1">
    <b>${escapeHtml(i.name)}</b><br/>
    <span class="small">
       ${formatMoney(i.price)} 
       <span class="qty-badge">x${i.qty}</span>
    </span>


    <div style="margin-top:4px">
  <input
    id="note-${i.id}"
    type="text"
    placeholder="Ghi ch√∫ (VD: √çT CAY, KH√îNG H√ÄNH...)"
    value="${escapeHtml(i.note || "")}"
    oninput="autoSaveNote('${i.id}', this.value)"
    style="font-weight:bold; width:100%;"
  />
</div>


  <div>
    <button onclick="changeQty('${i.id}',-1)">-</button>
    <button onclick="changeQty('${i.id}',1)">+</button>
  </div>
`;

  cartList.appendChild(row);
  total += i.price * i.qty;
});


  totalAmountEl.textContent = formatMoney(total);
}


  
   // ========== Orders: create + realtime last order ==========
  
  ordersRef
  .orderBy("createdAt", "desc")
  .limit(1)
  .onSnapshot(snap => {
    if(!snap.empty){
      const doc = snap.docs[0];
      renderLastOrder({
        id: doc.id,
        ...doc.data()
      });
    }
  });


  btnPay.onclick = async () => {
  if(!currentTable) return alert("Ch∆∞a ch·ªçn b√†n");

  const cart = currentTable.cart || [];

  if(cart.length===0) return alert("B√†n tr·ªëng");

  // B√†n nh√¢n vi√™n
  if(currentTable.type==="staff"){
    alert("B√†n nh√¢n vi√™n ƒÉn ‚Äì kh√¥ng t√≠nh doanh thu");
    
    return;
  }

  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const dateKey = new Date().toISOString().slice(0,10);

  await ordersRef.add({
  	tableId: currentTable.id,
  	tableName: currentTable.name,
  	items: cart,
 	total,
  	paymentMethod: paymentMethod.value,
  	createdAt: firebase.firestore.FieldValue.serverTimestamp(),
  	createdBy: "Tr∆∞∆°ng ƒê·∫∑ng"   // ng∆∞·ªùi l√†m m·∫∑c ƒë·ªãnh
  });


  const dailyRef = db.collection("stores").doc(storeId).collection("daily").doc(dateKey);
  await db.runTransaction(async(tx)=>{
    const snap = await tx.get(dailyRef);
    let data = { date: dateKey, totalRevenue: 0, products: {} };
    if(snap.exists) data = snap.data();

    data.totalRevenue += total;
    cart.forEach(i=>{
      if(!data.products[i.name]) data.products[i.name] = 0;
      data.products[i.name] += i.qty;
    });

    tx.set(dailyRef, data, {merge:true});
  });

  alert("Thanh to√°n xong cho " + currentTable.name);

  await tablesRef.doc(String(currentTable.id)).set({
  cart: [],
  status: "empty",
  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });

// reset b√†n hi·ªán t·∫°i
currentTable = null;

// quay v·ªÅ m√†n h√¨nh ch·ªçn b√†n
document.getElementById("orderScreen").classList.add("hidden");
document.getElementById("tableScreen").classList.remove("hidden");

// v·∫Ω l·∫°i b√†n ngay cho m∆∞·ª£t
renderTables();

};


  function listenTables(){
  tablesRef.onSnapshot(snap => {
    snap.forEach(doc => {
      const data = doc.data();
      const t = tables.find(x => String(x.id) === doc.id);

      if(t){
 	 t.cart = data.cart || [];
 	 t.status = data.status || (t.cart.length > 0 ? "busy" : "empty");
      }

    });

    // v·∫Ω l·∫°i b√†n
    renderTables();

    // n·∫øu ƒëang ch·ªçn 1 b√†n th√¨ c·∫≠p nh·∫≠t cart c·ªßa b√†n ƒë√≥
    if(currentTable){
      const match = tables.find(x => x.id === currentTable.id);
      if(match){
        currentTable = match;
        renderCart();
      }
    }
  });
}

  function renderLastOrder(order){
    const time = order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : '‚Äî';
    lastOrderEl.innerHTML = `
      <div><b>ID:</b> ${order.id}</div>
      <div><b>Ng∆∞·ªùi l√†m:</b> ${order.createdByEmail||order.createdBy}</div>
      <div><b>Th·ªùi gian:</b> ${escapeHtml(time)}</div>
      <div><b>T·ªïng:</b> ${formatMoney(order.total)} VNƒê</div>
      <div style="margin-top:8px">
        <b>Items:</b>
        <ul>
          ${order.items.map(i=>`<li>${escapeHtml(i.name)} x${i.qty} ‚Äî ${formatMoney(i.price)} each</li>`).join('')}
        </ul>
      </div>
    `;
    btnPrintInvoice.classList.remove('hidden');
    btnPrintInvoice.onclick = ()=> {
      printOrder(order);
    };
  }

  function printOrder(order){
    const html = `
      <html><head><title>Invoice ${order.id}</title>
        <style>body{font-family:Arial;} h3{margin-bottom:0}</style>
      </head><body>
        <h3>H√≥a ƒë∆°n - ${escapeHtml(order.id)}</h3>
	<div><b>B√†n:</b> ${escapeHtml(order.tableName || order.tableId)}</div>
	<div><b>Ng∆∞·ªùi l√†m:</b> ${escapeHtml(order.createdBy)}</div>
	<div><b>Th·ªùi gian:</b> ${order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleString() : ''}</div>
        <hr/>
        <ul>
         ${order.items.map(i=>`
 	 <li>
 	   ${escapeHtml(i.name)} x${i.qty} ‚Äî ${formatMoney(i.price)} VNƒê
 	   ${i.note ? `<div><b>GHI CH√ö:</b> ${escapeHtml(i.note)}</div>` : ""}
	  </li>
	`).join('')}

        </ul>
        <hr/>
        <div><b>T·ªïng: ${formatMoney(order.total)} VNƒê</b></div>
      </body></html>
    `;
    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
    w.print();
  }

  // ======= util =======
  function formatMoney(n){ return new Intl.NumberFormat('en-US').format(n); }
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  

  // ========== OPTIONAL: Firestore rules suggestion ==========
  // Note: you must set rules in Firebase Console; below is a recommended starting point:
  /*
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /stores/{storeId}/{docPath=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
        // For production, restrict writes by role/custom claims
      }
    }
  }
  */


const tables = [
  {id:1,name:"C1",type:"normal",status:"empty", x:20, y:20},
  {id:2,name:"C2",type:"normal",status:"empty", x:20, y:90},
  {id:3,name:"C3",type:"normal",status:"empty", x:20, y:160},

  {id:4,name:"C4",type:"normal",status:"empty", x:120, y:20},
  {id:5,name:"C5",type:"normal",status:"empty", x:120, y:90},
  {id:6,name:"C6",type:"normal",status:"empty", x:120, y:160},

  {id:7,name:"C7",type:"normal",status:"empty", x:240, y:50},
  {id:8,name:"C8",type:"normal",status:"empty", x:240, y:130},

  {id:9,name:"T1",type:"normal",status:"empty", x:20, y:260},
  {id:10,name:"T2",type:"normal",status:"empty", x:120, y:260},

  {id:99,name:"Nh√¢n vi√™n",type:"staff",status:"empty", x:20, y:330},
  {id:100, name:"Mang v·ªÅ", type:"takeaway", status:"empty", x:120, y:330},
];
 async function initTablesToFirestore(){
  const snap = await tablesRef.get();
  if(!snap.empty) return;

  for(const t of tables){
    await tablesRef.doc(String(t.id)).set({
      name: t.name,
      type: t.type,
      status: "empty",
      cart: [],
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  console.log("ƒê√£ init tables l√™n Firestore");
  }




const tablesGrid = document.getElementById("tablesGrid");

function renderTables(){
      console.log("TABLES ARRAY:", tables);

  tablesGrid.innerHTML="";
  tables.forEach(t=>{
    const div=document.createElement("div");
    div.className="table";
    div.style.left=t.x+"px";
    div.style.top=t.y+"px";

    if(t.type==="staff") div.classList.add("staff");
    else div.classList.add(t.status==="empty" ? "empty" : "busy");

    if(currentTable && currentTable.id === t.id){
      div.classList.add("active");
    }

    div.textContent=t.name;

    div.onclick = () => {
  console.log("CLICK TABLE:", t);   // log ƒë·ªÉ xem t l√† g√¨

  if(!t){
    console.error("Table is undefined");
    return;
  }

  if(!t.cart){
    t.cart = [];
  }

  currentTable = t;

  document.getElementById("tableScreen").classList.add("hidden");
  document.getElementById("orderScreen").classList.remove("hidden");

  renderTables();
  renderCart();
};



    tablesGrid.appendChild(div);
  });
}

const btnHistory = document.getElementById("btnHistory");
const historyView = document.getElementById("historyView");
const tableScreen = document.getElementById("tableScreen");
const orderScreen = document.getElementById("orderScreen");
const btnBack = document.getElementById("btnBack");

btnHistory.onclick = () => {
  if(!currentUser || currentUser.role !== "owner"){
    return alert("B·∫°n kh√¥ng c√≥ quy·ªÅn xem l·ªãch s·ª≠ b√°n h√†ng");
  }
  tableScreen.classList.add("hidden");
  orderScreen.classList.add("hidden");
  historyView.classList.remove("hidden");
  loadHistoryDays();
  
};

btnBack.onclick = () => {
  historyView.classList.add("hidden");
  tableScreen.classList.remove("hidden");
};


async function loadHistoryDays(){
  const daysList = document.getElementById("daysList");
  daysList.innerHTML = "ƒêang t·∫£i...";

  const snap = await db.collection("stores")
    .doc(storeId)
    .collection("daily")
    .orderBy("date","desc")
    .limit(7)
    .get();

  daysList.innerHTML = "";

  snap.forEach(doc=>{
    const d = doc.data();
    const btn = document.createElement("button");
    btn.style.margin = "4px";
    btn.textContent = d.date + " ‚Äì " + formatMoney(d.totalRevenue) + " VNƒê";
    btn.onclick = ()=> loadDayDetail(d.date);
    daysList.appendChild(btn);
  });
}

async function loadDayDetail(dateKey){
  const detail = document.getElementById("dayDetail");
  detail.innerHTML = "ƒêang t·∫£i chi ti·∫øt...";

  const start = new Date(dateKey + "T00:00:00");
  const end = new Date(dateKey + "T23:59:59");

  const ordersSnap = await ordersRef
    .where("createdAt", ">=", start)
    .where("createdAt", "<=", end)
    .get();

  let totalDay = 0;
  let totalCash = 0;
  let totalTransfer = 0;
  let productSummary = {};
  let html = `<h4>Ng√†y ${dateKey}</h4>`;

  ordersSnap.forEach(doc=>{
    const o = doc.data();
    totalDay += o.total;

    if(o.paymentMethod === "cash"){
      totalCash += o.total;
    }else if(o.paymentMethod === "momo"){
      totalTransfer += o.total;
    }

    o.items.forEach(i=>{
      if(!productSummary[i.name]) productSummary[i.name]=0;
      productSummary[i.name]+=i.qty;
    });

    html += `
      <div class="panel">
        <b>B√†n:</b> ${o.tableName || o.tableId} ‚Äì ${formatMoney(o.total)} VNƒê
        <div class="small">Thanh to√°n: ${
          o.paymentMethod === "cash" ? "Ti·ªÅn m·∫∑t" : "Chuy·ªÉn kho·∫£n"
        }</div>
      </div>
    `;
  });

  html += `<hr/><h4>T·ªïng h·ª£p m√≥n</h4><ul>`;
  for(let k in productSummary){
    html += `<li>${k}: ${productSummary[k]} ph·∫ßn</li>`;
  }
  html += `</ul>`;

  html += `
    <div style="margin-top:10px">
      <b>T·ªïng doanh thu:</b> ${formatMoney(totalDay)} VNƒê
    </div>
    <div class="small" style="margin-top:4px">
      üßæ Ti·ªÅn m·∫∑t: <b style="color:#16a34a">${formatMoney(totalCash)} VNƒê</b>
    </div>
    <div class="small">
      üí≥ Chuy·ªÉn kho·∫£n: <b style="color:#2563eb">${formatMoney(totalTransfer)} VNƒê</b>
    </div>
  `;

  detail.innerHTML = html;
}

function changeTable() {
  currentTable = null; // b·ªè ch·ªçn b√†n hi·ªán t·∫°i

  // ·∫®n giao di·ªán order
  document.getElementById("orderScreen").classList.add("hidden");

  // Hi·ªán l·∫°i giao di·ªán ch·ªçn b√†n
  document.getElementById("tableScreen").classList.remove("hidden");

  // Reset l·∫°i hi·ªÉn th·ªã b√†n
  document.getElementById("tableNumberDisplay").innerText = "B√†n: --";
}

window.onload = async () => {
  await initTablesToFirestore();
  listenTables();
};

let noteTimeout = null;

async function autoSaveNote(productId, value){
  if(!currentTable) return;

  // √©p ch·ªØ hoa
  const note = value.toUpperCase();

  let cart = currentTable.cart || [];
  const idx = cart.findIndex(i => i.id === productId);
  if(idx < 0) return;

  cart[idx].note = note;

  // ch·ªëng spam Firestore: ch·ªâ l∆∞u sau 500ms ng·ª´ng g√µ
  clearTimeout(noteTimeout);
  noteTimeout = setTimeout(async () => {
    await tablesRef.doc(String(currentTable.id)).set({
      cart: cart,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    console.log("ƒê√£ auto-save ghi ch√∫:", cart[idx].name, note);
  }, 500);
}
</script>
</body>
</html>
