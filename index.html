<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Tiệm Ăn Con Ếch</title>

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#eef2f7;
}
header{
  background:#2563eb;
  color:white;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,.2);
}
header h2{margin:0}

header input{
  padding:6px 8px;
  border-radius:6px;
  border:none;
  outline:none;
}
header button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:white;
  color:#2563eb;
  font-weight:600;
}

.container{
  display:none;
  grid-template-columns:300px 1fr 320px;
  gap:12px;
  padding:12px;
  height:calc(100vh - 70px);
  box-sizing:border-box;
}
.panel{
  background:white;
  border-radius:12px;
  padding:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.1);
  display:flex;
  flex-direction:column;
}

.panel h3{
  margin:0 0 10px 0;
  border-bottom:1px solid #ddd;
  padding-bottom:6px;
}

/* Bàn */
#tablesGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
.table{
  padding:14px;
  border-radius:10px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  transition:.15s;
}
.table.empty{ background:#e5e7eb; }
.table.busy{ background:#fde68a; }
.table.staff{ background:#9ca3af;color:white; }
.table.active{ outline:3px solid #2563eb; }

/* Sản phẩm */
#productsList div{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 0;
  border-bottom:1px dashed #ddd;
}
#productsList button{
  padding:4px 10px;
  border:none;
  border-radius:6px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}

/* Giỏ hàng */
#cartList div{
  display:flex;
  justify-content:space-between;
  padding:4px 0;
}
.cart-footer{
  margin-top:auto;
}
.cart-footer button{
  width:100%;
  margin-top:6px;
  padding:10px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
#btnPay{
  background:#22c55e;
  color:white;
}
#btnClear{
  background:#ef4444;
  color:white;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>
  <h2>Tiệm Ăn Con Ếch</h2>
  <div>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mật khẩu">
    <button id="btnLogin">Đăng nhập</button>
    <button id="btnSignup">Tạo user</button>
    <button id="btnLogout">Đăng xuất</button>
  </div>
</header>

<div class="container">

  <!-- BÀN -->
  <div class="panel">
    <h3>Bàn</h3>
    <div id="tablesGrid"></div>
  </div>

  <!-- SẢN PHẨM -->
  <div class="panel">
    <h3>Sản phẩm</h3>
    <div id="productsList" style="flex:1;overflow:auto"></div>

    <hr>
    <input id="pName" placeholder="Tên sản phẩm">
    <input id="pPrice" type="number" placeholder="Giá">
    <button id="btnAddProduct">Thêm sản phẩm</button>
  </div>

  <!-- GIỎ -->
  <div class="panel">
    <h3>Giỏ hàng</h3>
    <div id="cartList" style="flex:1;overflow:auto"></div>

    <div class="cart-footer">
      <p>Tổng: <b id="totalAmount">0</b> VNĐ</p>
      <select id="paymentMethod">
        <option value="cash">Tiền mặt</option>
        <option value="bank">Chuyển khoản</option>
      </select>
      <button id="btnPay">Thanh toán</button>
      <button id="btnClear">Xóa giỏ</button>
    </div>
  </div>

</div>
<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC-AaAzc1qOsRjs1Pa3IrHKRtT4ID2incI",
  authDomain: "pos-quocanh.firebaseapp.com",
  projectId: "pos-quocanh",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== Tables ===== */
const tables = [
  {id:1,name:"C1",type:"normal",status:"empty"},
  {id:2,name:"C2",type:"normal",status:"empty"},
  {id:3,name:"C3",type:"normal",status:"empty"},
  {id:4,name:"C4",type:"normal",status:"empty"},
  {id:5,name:"C5",type:"normal",status:"empty"},
  {id:6,name:"C6",type:"normal",status:"empty"},
  {id:7,name:"C7",type:"normal",status:"empty"},
  {id:8,name:"C8",type:"normal",status:"empty"},
  {id:9,name:"T1",type:"normal",status:"empty"},
  {id:10,name:"T2",type:"normal",status:"empty"},
  {id:99,name:"Nhân viên ăn",type:"staff",status:"empty"},
];
let currentTable=null;
const tablesGrid=document.getElementById("tablesGrid");

function renderTables(){
  tablesGrid.innerHTML="";
  tables.forEach(t=>{
    const div=document.createElement("div");
    div.className="table";

    if(t.type==="staff") div.classList.add("staff");
    else div.classList.add(t.status==="empty"?"empty":"busy");

    div.textContent=t.name;

    div.onclick=()=>{
      currentTable=t;
      document.querySelectorAll(".table").forEach(x=>x.classList.remove("active"));
      div.classList.add("active");
    };

    tablesGrid.appendChild(div);
  });
}
renderTables();

/* ===== Auth ===== */
btnSignup.onclick=async()=>{
  await auth.createUserWithEmailAndPassword(email.value,password.value);
  alert("Tạo user xong");
};
btnLogin.onclick=async()=>{
  await auth.signInWithEmailAndPassword(email.value,password.value);
};
btnLogout.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(user){
    document.querySelector(".container").style.display="grid";

    const ref=db.collection("users").doc(user.uid);
    const snap=await ref.get();
    if(!snap.exists){
      let role="staff";
      if(user.email==="tiemanconech@admin.local") role="owner";
      await ref.set({
        email:user.email,
        role,
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    alert("Đăng nhập thành công: "+user.email);
  }else{
    document.querySelector(".container").style.display="none";
  }
});
/* ===== Products ===== */
const storeId="demo-store";
const productsRef=db.collection("stores").doc(storeId).collection("products");
let products=[];
productsRef.onSnapshot(snap=>{
  products=[];
  snap.forEach(d=>products.push({id:d.id,...d.data()}));
  renderProducts();
});

function renderProducts(){
  productsList.innerHTML="";
  products.forEach(p=>{
    const div=document.createElement("div");
    div.innerHTML=`${p.name} - ${p.price} VNĐ 
    <button onclick="addToCart('${p.id}')">+</button>`;
    productsList.appendChild(div);
  });
}

btnAddProduct.onclick=async()=>{
  const name=pName.value;
  const price=parseInt(pPrice.value);
  const id=name.toLowerCase().replace(/\s+/g,"-");
  await productsRef.doc(id).set({name,price});
  alert("Đã thêm sản phẩm");
};

/* ===== Cart ===== */
let cart=[];

function addToCart(id){
  if(!currentTable) return alert("Chọn bàn trước");

  const p=products.find(x=>x.id===id);
  let item=cart.find(x=>x.id===id);
  if(item) item.qty++;
  else cart.push({...p,qty:1});

  if(currentTable.type==="normal"){
    currentTable.status="busy";
    renderTables();
  }

  renderCart();
}

function renderCart(){
  cartList.innerHTML="";
  let total=0;
  cart.forEach(i=>{
    total+=i.price*i.qty;
    const div=document.createElement("div");
    div.textContent=`${i.name} x${i.qty}`;
    cartList.appendChild(div);
  });
  totalAmount.textContent=total;
}

btnClear.onclick=()=>{
  cart=[];
  renderCart();
};

/* ===== Thanh toán + lịch sử ngày ===== */
const ordersRef=db.collection("stores").doc(storeId).collection("orders");
const dailyRef=db.collection("stores").doc(storeId).collection("daily");

function todayKey(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

btnPay.onclick=async()=>{
  if(!currentTable) return alert("Chưa chọn bàn");
  if(cart.length===0) return alert("Giỏ trống");

  // Bàn nhân viên ăn -> không ghi doanh thu
  if(currentTable.type==="staff"){
    alert("Bàn nhân viên ăn – không tính doanh thu");
    cart=[];
    renderCart();
    currentTable.status="empty";
    renderTables();
    return;
  }

  const total=cart.reduce((s,i)=>s+i.price*i.qty,0);
  const dateKey=todayKey();

  // Lưu order
  await ordersRef.add({
    tableId:currentTable.id,
    tableName:currentTable.name,
    items:cart,
    total,
    paymentMethod:paymentMethod.value,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  // Cập nhật lịch sử ngày
  const dailyDoc=dailyRef.doc(dateKey);
  await db.runTransaction(async(tx)=>{
    const snap=await tx.get(dailyDoc);
    let data={
      date:dateKey,
      totalRevenue:0,
      products:{}
    };

    if(snap.exists) data=snap.data();

    data.totalRevenue+=total;

    cart.forEach(i=>{
      if(!data.products[i.name]) data.products[i.name]=0;
      data.products[i.name]+=i.qty;
    });

    tx.set(dailyDoc,data,{merge:true});
  });

  alert("Thanh toán xong cho "+currentTable.name);

  cart=[];
  renderCart();
  currentTable.status="empty";
  renderTables();
};
</script>

</body>
</html>
