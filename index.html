<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>POS Tiệm Ăn Con Ếch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#f2f4f7;
}
header{
  background:#1f7ae0;
  color:white;
  padding:12px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
}
.container{
  padding:10px;
}
.panel{
  background:white;
  padding:12px;
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  margin-bottom:12px;
}

/* TABLE */
#tablesGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.table{
  padding:22px;
  border-radius:12px;
  text-align:center;
  font-size:18px;
  font-weight:700;
  cursor:pointer;
}
.table.empty{background:#d9d9d9;}
.table.busy{background:#ffd54f;}
.table.staff{background:#9e9e9e;color:white;}
.table.active{outline:4px solid #1f7ae0;}

/* PRODUCTS */
.product{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #eee;
}
.product button{
  width:40px;
  height:40px;
  font-size:20px;
}

/* CART */
.cart-item{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  font-size:16px;
}

button, select, input{
  width:100%;
  padding:12px;
  font-size:16px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
}

.primary{
  background:#1f7ae0;
  color:white;
  border:none;
}
.warning{
  background:#ff5252;
  color:white;
  border:none;
}
.secondary{
  background:#607d8b;
  color:white;
  border:none;
}

/* HISTORY SCREEN */
#historyScreen{
  display:none;
}
.day-item{
  padding:10px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.day-item b{
  color:#1f7ae0;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>

<header>POS – Tiệm Ăn Con Ếch</header>

<!-- MAIN POS -->
<div id="posScreen" class="container">

  <div class="panel">
    <h3>Bàn</h3>
    <div id="tablesGrid"></div>
  </div>

  <div class="panel">
    <h3>Sản phẩm</h3>
    <div id="productsList"></div>
  </div>

  <div class="panel">
    <h3>Giỏ hàng</h3>
    <div id="cartList"></div>
    <p>Tổng: <b id="totalAmount">0</b> VNĐ</p>

    <select id="paymentMethod">
      <option value="cash">Tiền mặt</option>
      <option value="bank">Chuyển khoản</option>
    </select>

    <button id="btnPay" class="primary">Thanh toán</button>
    <button id="btnClear" class="warning">Xóa giỏ</button>
  </div>

  <div class="panel">
    <button id="btnViewHistory" class="secondary">Xem lịch sử doanh thu</button>
  </div>

</div>

<!-- HISTORY -->
<div id="historyScreen" class="container">

  <div class="panel">
    <button id="btnBack" class="secondary">← Quay lại POS</button>
    <h3>Lịch sử doanh thu theo ngày</h3>
    <div id="historyList"></div>
  </div>

  <div class="panel" id="historyDetail" style="display:none;">
    <h3>Chi tiết ngày: <span id="detailDate"></span></h3>
    <p>Tổng doanh thu: <b id="detailTotal">0</b></p>
    <p>Tiền mặt: <b id="detailCash">0</b></p>
    <p>Chuyển khoản: <b id="detailBank">0</b></p>
    <h4>Số lượng món:</h4>
    <div id="detailProducts"></div>
  </div>

</div>
<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyC-AaAzc1qOsRjs1Pa3IrHKRtT4ID2incI",
  authDomain: "pos-quocanh.firebaseapp.com",
  projectId: "pos-quocanh",
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storeId = "demo-store";
/* ================= DOM ELEMENTS ================= */
const productsList = document.getElementById("productsList");
const cartList = document.getElementById("cartList");
const totalAmount = document.getElementById("totalAmount");
const paymentMethod = document.getElementById("paymentMethod");

const btnPay = document.getElementById("btnPay");
const btnClear = document.getElementById("btnClear");
const btnViewHistory = document.getElementById("btnViewHistory");
const btnBack = document.getElementById("btnBack");

const posScreen = document.getElementById("posScreen");
const historyScreen = document.getElementById("historyScreen");
const historyList = document.getElementById("historyList");

const historyDetail = document.getElementById("historyDetail");
const detailDate = document.getElementById("detailDate");
const detailTotal = document.getElementById("detailTotal");
const detailCash = document.getElementById("detailCash");
const detailBank = document.getElementById("detailBank");
const detailProducts = document.getElementById("detailProducts");


/* ================= TABLES ================= */
const tables = [
  {id:1,name:"C1",type:"normal",status:"empty"},
  {id:2,name:"C2",type:"normal",status:"empty"},
  {id:3,name:"C3",type:"normal",status:"empty"},
  {id:4,name:"C4",type:"normal",status:"empty"},
  {id:5,name:"C5",type:"normal",status:"empty"},
  {id:6,name:"C6",type:"normal",status:"empty"},
  {id:7,name:"C7",type:"normal",status:"empty"},
  {id:8,name:"C8",type:"normal",status:"empty"},
  {id:9,name:"T1",type:"normal",status:"empty"},
  {id:10,name:"T2",type:"normal",status:"empty"},
  {id:99,name:"Nhân viên",type:"staff",status:"empty"},
];

let currentTable = null;
const tablesGrid = document.getElementById("tablesGrid");

function renderTables(){
  tablesGrid.innerHTML="";
  tables.forEach(t=>{
    const div=document.createElement("div");
    div.className="table";
    if(t.type==="staff") div.classList.add("staff");
    else div.classList.add(t.status==="empty"?"empty":"busy");
    div.textContent=t.name;

    div.onclick=()=>{
      currentTable=t;
      document.querySelectorAll(".table").forEach(x=>x.classList.remove("active"));
      div.classList.add("active");
    };
    tablesGrid.appendChild(div);
  });
}
renderTables();

/* ================= PRODUCTS ================= */
const productsRef = db.collection("stores").doc(storeId).collection("products");
let products=[];

productsRef.onSnapshot(snap=>{
  products=[];
  snap.forEach(d=>products.push({id:d.id,...d.data()}));
  renderProducts();
});

function renderProducts(){
  productsList.innerHTML="";
  products.forEach(p=>{
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`
      <span>${p.name} - ${p.price}đ</span>
      <button onclick="addToCart('${p.id}')">+</button>
    `;
    productsList.appendChild(div);
  });
}

/* ================= CART ================= */
let cart=[];

function addToCart(id){
  if(!currentTable) return alert("Chọn bàn trước");
  const p=products.find(x=>x.id===id);
  let item=cart.find(x=>x.id===id);
  if(item) item.qty++;
  else cart.push({...p,qty:1});

  if(currentTable.type==="normal"){
    currentTable.status="busy";
    renderTables();
  }
  renderCart();
}

function renderCart(){
  cartList.innerHTML="";
  let total=0;
  cart.forEach(i=>{
    total+=i.price*i.qty;
    const div=document.createElement("div");
    div.className="cart-item";
    div.textContent=`${i.name} x${i.qty}`;
    cartList.appendChild(div);
  });
  totalAmount.textContent=total.toLocaleString();
}

btnClear.onclick=()=>{
  cart=[];
  renderCart();
};

/* ================= HISTORY HELPERS ================= */
const ordersRef = db.collection("stores").doc(storeId).collection("orders");
const dailyRef  = db.collection("stores").doc(storeId).collection("daily");

function todayKey(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}

/* ================= PAYMENT ================= */
btnPay.onclick=async()=>{
  if(!currentTable) return alert("Chưa chọn bàn");
  if(cart.length===0) return alert("Giỏ trống");

  // Nhân viên ăn: không tính doanh thu
  if(currentTable.type==="staff"){
    alert("Bàn nhân viên – không tính doanh thu");
    cart=[];
    renderCart();
    currentTable.status="empty";
    renderTables();
    return;
  }

  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const payMethod = paymentMethod.value;
  const dateKey = todayKey();

  // Lưu order
  await ordersRef.add({
    table: currentTable.name,
    items: cart,
    total,
    paymentMethod: payMethod,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Update daily history
  const dailyDoc = dailyRef.doc(dateKey);
  await db.runTransaction(async(tx)=>{
    const snap = await tx.get(dailyDoc);
    let data = {
      date: dateKey,
      totalRevenue: 0,
      cash: 0,
      bank: 0,
      products: {}
    };

    if(snap.exists) data = snap.data();

    data.totalRevenue += total;
    if(payMethod==="cash") data.cash += total;
    if(payMethod==="bank") data.bank += total;

    cart.forEach(i=>{
      if(!data.products[i.name]) data.products[i.name]=0;
      data.products[i.name]+=i.qty;
    });

    tx.set(dailyDoc,data,{merge:true});
  });

  alert("Thanh toán xong cho bàn " + currentTable.name);

  cart=[];
  renderCart();
  currentTable.status="empty";
  renderTables();
};

/* ================= HISTORY VIEW ================= */
btnViewHistory.onclick=()=>{
  posScreen.style.display="none";
  historyScreen.style.display="block";
  loadHistory();
};

btnBack.onclick=()=>{
  posScreen.style.display="block";
  historyScreen.style.display="none";
};

function loadHistory(){
  historyList.innerHTML="";
  dailyRef.orderBy("date","desc").onSnapshot(snap=>{
    historyList.innerHTML="";
    snap.forEach(d=>{
      const data=d.data();
      const div=document.createElement("div");
      div.className="day-item";
      div.innerHTML=`<b>${data.date}</b> - ${data.totalRevenue.toLocaleString()} đ`;
      div.onclick=()=>showHistoryDetail(data);
      historyList.appendChild(div);
    });
  });
}

function showHistoryDetail(data){
  historyDetail.style.display="block";
  detailDate.textContent=data.date;
  detailTotal.textContent=data.totalRevenue.toLocaleString();
  detailCash.textContent=data.cash.toLocaleString();
  detailBank.textContent=data.bank.toLocaleString();

  detailProducts.innerHTML="";
  for(let k in data.products){
    const div=document.createElement("div");
    div.textContent=`${k}: ${data.products[k]}`;
    detailProducts.appendChild(div);
  }
}
</script>
</body>
</html>
